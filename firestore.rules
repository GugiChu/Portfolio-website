rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions for validation
    function isValidEmail(email) {
      return email is string && email.matches('^[^@]+@[^@]+\\.[a-zA-Z]{2,}$');
    }
    
    function isNonEmptyString(text) {
      return text is string && text.size() > 0;
    }

    match /contacts/{document} {
      // Allow create public (validated)
      allow create: if request.resource.data.keys().hasAll(['name', 'email', 'serviceType', 'budget', 'vision', 'createdAt'])
                    && isNonEmptyString(request.resource.data.name)
                    && isValidEmail(request.resource.data.email)
                    && isNonEmptyString(request.resource.data.serviceType)
                    && isNonEmptyString(request.resource.data.budget)
                    && request.resource.data.vision is string && request.resource.data.vision.size() < 5000
                    && request.resource.data.createdAt is timestamp;
      
      // Allow read for authenticated admins
      allow read: if request.auth != null;
      allow update, delete: if false;
    }
    
    match /appointments/{document} {
      // Allow create public (validated)
      allow create: if request.resource.data.keys().hasAll(['fullName', 'mobile', 'createdAt'])
                    && isNonEmptyString(request.resource.data.fullName)
                    && isNonEmptyString(request.resource.data.mobile) && request.resource.data.mobile.size() >= 5
                    && request.resource.data.createdAt is timestamp;
      
      // Allow read for authenticated admins
      allow read: if request.auth != null;
      allow update, delete: if false;
    }
  }
}
